<!DOCTYPE html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0"/>

	<link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<link type="text/css" rel="stylesheet" href="css/materialize.min.css"  media="screen,projection"/>
    
     <script type="text/javascript" src="js/jquery-3.2.0.min.js"></script>
     <script type="text/javascript" src="js/materialize.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.7.5/firebase.js"></script>
 	<script type="text/javascript" src="js/authentication.js"></script>
    <script type="text/javascript" src="js/materialize.clockpicker.js"></script>
	<meta http-equiv = "X-UA-Compatible" content = "IE=edge,chrome=1">
	<link type="text/css" rel="stylesheet" href="css/materialize.clockpicker.css" media="screen,projection"/>
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link rel="stylesheet" href="css/detail.css">

    <title>Set_Detail</title>
			
</head>
<body>
		<div class = "navbar-fixed">
        <nav class="navbar at_top" role="navigation">
            <div class="nav-wrapper container"><a id="logo-container" href="#" class="brand-logo"><img class="logo" src="images/專題logo font-04.png" alt="booKing"></a>
            <a href="#" data-activates="nav-mobile" class="button-collapse"><i class="material-icons">menu</i></a>
              <ul class="right hide-on-med-and-down"> 
                      <li>
                        <div class="switch">
                            <label style="font-weight: bold;">
                            預約顧客
                            <input type="checkbox" onchange="state_change(2)" id="account_state1" checked="checked">
                            <span class="lever"></span>
                            場地主
                            </label>
                        </div>
                      </li>
                      <t id="change_state1">
                        <li><a class="waves-effect" href="#manager_manageIndex.html">管理場地</a></li>
                        <li><a class="waves-effect" href="manager_basic.html">新增預約空間</a></li>
                        <li><a class="waves-effect" href="#">說明</a></li>
                      </t>
                  
                      <li class="lijustify">
                        <div class="login_part">
                          <a class="waves-effect waves-light btn" href="#SignInmodal">登入</a>
                        </div>
                        <div class="logout_part" style="display: none">
                          <a class="waves-effect waves-light btn" onclick="toggleSignIn()">登出</a>
                        </div>
                      </li>
                  </ul>
            </div>
          </nav>
      </div>
    <!--Slidenav start--><!--Must put this out of nav block so it can be fixed-->
    <ul id="nav-mobile" class="side-nav">
        <li><a onclick="$('.button-collapse').sideNav('hide');"><i class="material-icons">clear_all</i></a></li>
        <li><div class="divider"></div></li>
        <li>
          <div class="userView" id="userView" style="display: none">
              <div class="background"> <img src="images/bookingBG.jpg"> </div>
              <img class="circle" id="profile_pic" src="http://i.imgur.com/BOGqUjA.gif">
              <span class="white-text name" id="user_Name"> </span> 
              <span class="white-text email" id="user_Email"> </span>
          </div>
          <div class="login_part">
            <a class="waves-effect waves-light btn" href="#SignInmodal">登入</a>
          </div>  
        </li> 
        <li><div class="switch center-align">
          <label style="font-weight: bold;">
            預約顧客
            <input type="checkbox" onchange="state_change(1)" id="account_state" checked="checked">
            <span class="lever"></span>
            場地主
          </label>
        </div></li>
        <div id="change_state">
          <li><a class="waves-effect" href="manager_manageIndex.html"><i class="material-icons">stars</i>管理場地</a></li>
          <li><a class="waves-effect" href="manager_basic.html"><i class="material-icons">room</i>新增預約場地</a></li>
          <li><a class="waves-effect" href="#!"><i class="material-icons">person_pin</i>說明</a></li>
      </div>
        <li>
          <div class="logout_part" style="display: none">
              <a class="waves-effect waves-light btn" onclick="toggleSignIn()">登出</a>
          </div>
        </li>
    </ul>
  <!--SlideNave end-->

  <div id="SignUpmodal" class="modal">
      <div class="modal-content">
          <div class="row margin logoarea">
            <img class="signuplogo" src="images/專題app icon-02.png" alt="booKing"></a>
          </div>
          <div class="row margin">
              <div class="input-field logininput">
                <!-- <i class="material-icons prefix">android</i> -->
                <input id="signup-username" type="text" >
                <label for="signup-username">用戶名</label>
              </div>
              <div class="input-field logininput">
                <!-- <i class="material-icons prefix">perm_media</i> -->
                <input id="signup-photo" type="text" >
                <label for="signup-photo">頭貼 URL</label>
              </div>
              <div class="input-field logininput">
                <!-- <i class="material-icons prefix">vpn_key</i> -->
                <textarea id="fire_base_textarea" class="materialize-textarea" value=""></textarea>
                <label for="signup-photo">Firebase 金鑰參數(必要)</label>
              </div>
          </div>
          <div class="signupnotation">
              <button class="waves-effect waves-light btn signupbtn" id="quickstart-sign-up" name="signup">Sign Up</button>
              <p>剛才輸入的Email與密碼已暫存了，</p>
              <p>剩下面的欄位囉!</p>
          </div>
      </div>
      <!-- <div class="modal-footer signupnotation">
          <button class="waves-effect waves-light btn signupbtn" id="quickstart-sign-up" name="signup">Sign Up</button>
          <p>剛才輸入的Email與密碼已暫存了，</p>
          <p>剩下面的欄位囉!</p>
      </div> -->
  </div>

  <div id="SignInmodal" class="modal">
      <div class="modal-content">
          <div class="row margin logoarea">
            <img class="loginlogo" src="images/專題logo font-04.png" alt="booKing"></a>
          </div>
          <br>
          <div class="row margin logininput">
            <!-- <i class="material-icons prefix">email</i> -->
            <input class="" type="email" id="email" name="email" placeholder="Email"/>
          </div>
          <div class="row margin logininput">
            <!-- <i class="material-icons prefix">vpn_key</i> -->
              <input  type="password" id="password" name="password" placeholder="Password"/>
          </div>
          <!--<button class="waves-effect waves-light btn" id="quickstart-password-reset">Forget password</button>-->

          <div class="loginnotation">
              <button class="waves-effect waves-light btn loginbtn" id="quickstart-sign-in" name="signin">Sign In</button>
              <p>還沒有帳號?直接打在上面送出吧!</p>
          </div>
      </div>
          
      <!-- <div class="modal-footer loginnotation">
          <button class="waves-effect waves-light btn loginbtn" id="quickstart-sign-in" name="signin">Sign In</button>
          <p>還沒有帳號?直接打在上面送出吧!</p>
      </div> -->
  </div>
	<br>
		
		<!--SlideNave end-->
				
    <br>
    <div class="container contentcolor">
	    <div class="row">
	    	<h3 class="col s12">設定預約時段</h3>
		    <form class="col s12">
		        <div class="row">
		          	<div class="input-field col s12">
		            	<label for="input_starttime">Start Time</label>
		            	<input id="input_starttime" class="timepicker" type="text">
		          	</div>
		        </div>
		        <div class="row">
		          	<div class="input-field col s12">
		            	<label for="input_endtime">End Time</label>
		            	<input id="input_endtime" class="timepicker" type="text">
		          	</div>
	        	</div>
	        	<p class="range-field">
	        		<label>欲設定時段數</label>
			      	<input type="range" id="timeset" min="1" max="24" value = "5" onchange = "timeSeg()" >
			    </p>
				<div id="show_segment"></div>
	      	</form>
	      	<br>

		        	<div class="input-field col s12">
			          	<textarea id="icon_prefix2" class="materialize-textarea validate"></textarea>
			          	<label for="icon_prefix2">相關簡介<i class="material-icons">mode_edit</i></label>
		        	</div>

	      	<button class="btn waves-effect waves-light" type="submit" name="action" onclick="certify_status()">Submit</button>
	    </div>
	</div>



<!-- preload start -->
    <div id="preloader_modal" class="modal center">
      <div class="modal-content">
        <div class="preloader-wrapper big active">
          <div class="spinner-layer spinner-blue-only">
            <div class="circle-clipper left">
              <div class="circle"></div>
            </div>
            <div class="gap-patch">
              <div class="circle"></div>
            </div>
            <div class="circle-clipper right">
              <div class="circle"></div>
            </div>
          </div>
        </div>
        <p>準備中,請稍待片刻...</p>
      </div>
    </div>
<!-- preload end -->


	<script type="text/javascript">
		//navbar是否在頂端
			$(window).scroll(function(e){
			  if ($(window).scrollTop()<=0)
			    $(".explore,.navbar").addClass("at_top");
			  else
			   $(".explore,.navbar").removeClass("at_top");
			});
		//-------------------------------
	</script>



    <script type="text/javascript">

          function state_change(change){
            if(change==1){
              if(document.getElementById('account_state').checked){
                document.getElementById('change_state').innerHTML=' <li><a class="waves-effect" href="manager_manageIndex.html"><i class="material-icons">stars</i>管理場地</a></li><li><a class="waves-effect" href="manager_basic.html"><i class="material-icons">room</i>新增預約場地</a></li><li><a class="waves-effect" href="#!"><i class="material-icons">person_pin</i>說明</a>';

                document.getElementById('change_state1').innerHTML='<li><a class="waves-effect" href="manager_manageIndex.html">管理場地</a></li><li><a class="waves-effect" href="manager_basic.html">新增預約場地</a></li><li><a class="waves-effect" href="#!"說明</a></li>';

                document.getElementById('account_state1').checked=true;
                document.getElementById('account_state').checked=true;
              }else{
                document.getElementById('change_state').innerHTML='<li><a class="waves-effect" href="user_search.html"><i class="material-icons">search</i>探索場地</a></li><li><a class="waves-effect" href="user_manageindex.html"><i class="material-icons">room</i>我的預約</a></li><li><a class="waves-effect" href="#!"><i class="material-icons">stars</i>願望清單</a></li>';

                document.getElementById('account_state1').checked=false;
                document.getElementById('account_state').checked=false;

                document.getElementById('change_state1').innerHTML='<li><a class="waves-effect" href="user_search.html">探索場地</a></li><li><a class="waves-effect" href="user_manageindex.html">我的預約</a></li><li><a class="waves-effect" href="#!">願望清單</a></li>';
              }
            }else{
              if(document.getElementById('account_state1').checked){
                document.getElementById('change_state').innerHTML=' <li><a class="waves-effect" href="manager_manageIndex.html"><i class="material-icons">stars</i>管理場地</a></li><li><a class="waves-effect" href="manager_basic.html"><i class="material-icons">room</i>新增預約場地</a></li><li><a class="waves-effect" href="#!"><i class="material-icons">person_pin</i>說明</a>';

                document.getElementById('change_state1').innerHTML='<li><a class="waves-effect" href="manager_manageIndex.html">管理場地</a></li><li><a class="waves-effect" href="manager_basic.html">新增預約場地</a></li><li><a class="waves-effect" href="#!">說明</a></li>';

                document.getElementById('account_state1').checked=true;
                document.getElementById('account_state').checked=true;
              }else{
                  document.getElementById('change_state').innerHTML='<li><a class="waves-effect" href="user_search.html"><i class="material-icons">search</i>探索場地</a></li><li><a class="waves-effect" href="user_manageindex.html"><i class="material-icons">room</i>我的預約</a></li><li><a class="waves-effect" href="#!"><i class="material-icons">stars</i>願望清單</a></li>';

                  document.getElementById('account_state1').checked=false;
                  document.getElementById('account_state').checked=false;
                  document.getElementById('change_state1').innerHTML='<li><a class="waves-effect" href="user_search.html">探索場地</a></li><li><a class="waves-effect" href="user_manageindex.html">我的預約</a></li><li><a class="waves-effect" href="#!">願望清單</a></li>';
              }
            }
          }



        
    	var segment = [];
		function timeSeg() {
			var start_time,end_time,start_dayOrNight,end_dayOrNight;
			segment=[];
			
			start_time = document.getElementById('input_starttime').value;			
			end_time = document.getElementById('input_endtime').value;
			start_time = start_time.split(":");
			end_time = end_time.split(":");

			var time_length,seperate_num;

			if(start_time.length != 2||end_time.length != 2){
				//請重新選擇
				alert('請確定填入起訖時間');				
			}
			else{
			    //顯示問題
				start_dayOrNight = start_time[1].slice(-2);
				end_dayOrNight = end_time[1].slice(-2);
				start_time[1] = start_time[1].substring(-2);
				end_time[1] = end_time[1].substring(-2);

				var start_toMin = 0
				var end_toMin = 0;
                
				if(start_dayOrNight == 'PM' && start_time[0] != '12')
				{
					start_time[0] = parseInt(start_time[0]) + 12;
				}
				if(end_dayOrNight == 'PM' && end_time[0] != '12'){
					end_time[0] = parseInt(end_time[0]) + 12;
				}
				if(start_dayOrNight == 'AM' && start_time[0] == '12'){
					start_time[0] = 0;
				}
				if(end_dayOrNight == 'AM' && end_time[0] == '12'){
					end_time[0] = 0;
				}
				start_toMin = parseInt(start_time[0]) * 60 + parseInt(start_time[1]);
				end_toMin = parseInt(end_time[0]) * 60 + parseInt(end_time[1]);
				if(start_toMin > end_toMin){
                    start_toMin = 1440 - start_toMin;
                    time_length = parseInt(start_toMin) + parseInt(end_toMin);                    
				} else{
					time_length = parseInt(end_toMin) - parseInt(start_toMin); 
				}

				seperate_num = document.getElementById('timeset').value;
				var each_segMin = parseInt(time_length / seperate_num);
			    
				if(each_segMin < 1){
					alert('你分配的時間太少不夠分出預約時段,請重新設定');
					document.getElementById('show_segment').innerHTML='';
				} else{
					document.getElementById('show_segment').innerHTML = '<table class="bordered"><thead><tr><th data-field="id">時間</th><th data-field="name">是否讓客人預約</th></tr></thead><tbody id="table_content"></tbody></table>';
					var current_hour, current_min, pass_hour, pass_min;//headtime用為第一次時間				
					current_hour = parseInt(start_time[0]);				
					current_min = parseInt(start_time[1]);
                    pass_hour = current_hour;
					for(var i = 0; i < seperate_num; i++)
					{
                       
                       pass_min = parseInt(current_min) + parseInt(each_segMin);

                    	while(pass_min >= 60)
                    	{
                       		pass_min-=60;
                       		pass_hour+=1;
                       	}

                       	while(pass_hour >= 24)
                       	{
                       		pass_hour-=24;                       	
                       	}

                       	current_min = parseInt(current_min);
                       	pass_min = parseInt(pass_min);

                       	var timeBlock_sentence = ("0" + Number(current_hour)).slice(-2) + ':' + ("0" + Number(current_min)).slice(-2) + '~' + ("0" + Number(pass_hour)).slice(-2) + ':' + ("0" + Number(pass_min)).slice(-2);
                       	segment.push(timeBlock_sentence);

                       	document.getElementById('table_content').innerHTML+=' <tr><td>'+ timeBlock_sentence + '</td><td><form action="#"><p><input type="checkbox" class="filled-in" id="checked' + i + '" checked="checked" /><label for="checked' + i + '"></label></p></form></td></tr>';
                       	current_hour = pass_hour;
                       	current_min = pass_min;
                       	pass_min = 0;
					}
				}						
			}
        }

	function certify_status()
	{
		// read for panoid
		var QueryString = function () {
			// This function is anonymous, is executed immediately and 
			// the return value is assigned to QueryString!
			var query_string = {};
			var query = window.location.search.substring(1);
			var vars = query.split("&");
			for (var i = 0; i < vars.length; i++) 
			{
				var pair = vars[i].split("=");
				// If first entry with this name
				if (typeof query_string[pair[0]] === "undefined") {
					query_string[pair[0]] = decodeURIComponent(pair[1]);
					// If second entry with this name
				} 
				else if (typeof query_string[pair[0]] === "string") {
					var arr = [ query_string[pair[0]],decodeURIComponent(pair[1]) ];
					query_string[pair[0]] = arr;
					// If third or later entry with this name
				} 
				else {
					query_string[pair[0]].push(decodeURIComponent(pair[1]));
				}
			} 
			return query_string;
		}();

		var spaceN = QueryString.SpaceN;

		// Initialize user_app
		var route=spaceN+"_time_segment";
		var active_status = [];
		var seg_num = document.getElementById('timeset').value;

		for(var i = 0; i < seg_num; i++)
		{
			var checkbox_id=document.getElementById('checked'+i).checked;
			if(checkbox_id==true){
				active_status.push('true');
			} else{
				active_status.push('rest');
			}
		}
		var dt = new Date();
		var c_day = dt.getDate();
		var c_month = dt.getMonth() + 1;
		var c_year = dt.getFullYear();
		user_app.database().ref(route).set(null);
		user_app.database().ref(route + '/current_time').set(c_year + "-" + c_month + "-" + c_day);
		//user_app.database().ref(spaceN +'/time_segment').set('');

		user_app.database().ref(spaceN + '/marker/room').once('value').then(function(snapshot) {
			var marker_num = snapshot.val().marker_num;
			user_app.database().ref(route + '/time_segment/seg_num').set(segment.length);
			for(var i = 0;i < segment.length;i++){                       
				 user_app.database().ref(route + '/time_segment/segment' + (i)).set(segment[i]);
			}

			for(var i = 0; i < marker_num; i++){
				dt=new Date(c_year,c_month-1,c_day);
				for(var k = 0; k < 14; k++){
					dt.setDate (dt.getDate() + 1);
					var day = dt.getDate();
					var month = dt.getMonth() + 1;
					var year = dt.getFullYear();
					user_app.database().ref(route +'/room/marker' + (i + 1) + '/' + year + "-" + month + "-" + day).set('');
				for(var j = 0;j < active_status.length; j++){
					user_app.database().ref(route + '/room/marker' + (i + 1) + '/' + c_year + "-" + c_month+ "-" + c_day+ '/segment' + j).set(active_status[j]);
				  	user_app.database().ref(route + '/room/marker' + (i + 1) + '/' + year + "-" + month + "-" + day + '/segment' + j).set(active_status[j]);
				}
			}
		}
		});	

		var card_json;
		user_app.database().ref(spaceN).once('value',function(snapshot){
			var user = authapp.auth().currentUser;
				card_json={
				name: snapshot.child('place_name').val(),
				photo: snapshot.child('photo_name').val(),
				description: snapshot.child('place_description').val(),
				address: snapshot.child('place_address').val(),
				provider: user.displayName,
				type_tag: snapshot.child('type_tag').val(),
				people_amount: snapshot.child('people_amount').val(),
        		space:spaceN,
				id: user.uid,
				img_url: snapshot.child('photo_url').val(),
				opendata:{
					rh: snapshot.child('open_data/rh').val(),
					fv: snapshot.child('open_data/fv').val(),
					ha: snapshot.child('open_data/ha').val()
				}
			};

			
		}).then(function(){
			authapp.database().ref('card').once('value',function(snap){
				var card_num=parseInt(snap.child('card_num').val());
				if(card_num==0){
					authapp.database().ref('card/card_num').set(1);
					user_app.database().ref(spaceN+'/card_index').set(1);
					authapp.database().ref('card/card1').set(card_json);
				}else{
					authapp.database().ref('card/card'+(card_num+1)).set(card_json);
					authapp.database().ref('card/card_num').set(card_num+1);
					user_app.database().ref(spaceN+'/card_index').set(card_num+1);
				}

			}).then(function(){
						Materialize.toast("上傳成功!",1500);
			});

		});

	}
	</script>
	    <script type="text/javascript">
		    $('#input_starttime').clockpicker({
		      placement: 'bottom',
		      align: 'left',
		      twelvehour: true
		    });
		    $('#input_endtime').clockpicker({
		      placement: 'bottom',
		      align: 'left',
		      darktheme: true,
		      twelvehour: true //If U want 24 hour just set false
		    });

		    $('.button-collapse').sideNav();

		</script>
		<script type="text/javascript">
			$('.modal').modal();
			$('.button-collapse').sideNav();
			initAuth();
	</script>
  	</body>
</html>